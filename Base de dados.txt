 ------------------AREA CONHECIMENTO-------------------

CREATE TABLE AREA_CONHECIMENTO(
    COD_AREA INTEGER NOT NULL,
    NOME_AREA VARCHAR(200));

ALTER TABLE AREA_CONHECIMENTO
ADD CONSTRAINT PK_AREA_CONHECIMENTO
PRIMARY KEY (COD_AREA);

CREATE SEQUENCE GEN_AREA;

CREATE TRIGGER AREA_BI FOR AREA_CONHECIMENTO
ACTIVE BEFORE INSERT POSITION 0
AS
BEGIN
 IF(NEW.COD_AREA IS NULL) THEN
    NEW.COD_AREA = GEN_ID(GEN_AREA, 1);
END;
    
------------------FormasPAg------------------------------

CREATE TABLE FORMASPAG(
    COD_FPG INTEGER NOT NULL,
    NOME_FPG VARCHAR(200),
    DESCRICAO_FPG VARCHAR (200)
);

ALTER TABLE FORMASPAG
ADD CONSTRAINT PK_FORMASPAG
 PRIMARY KEY(COD_FPG);

CREATE SEQUENCE GEN_FORMASPAG;

CREATE TRIGGER FORMASPAG_BI FOR FORMASPAG
ACTIVE BEFORE INSERT POSITION 0
AS
BEGIN
  IF(NEW.COD_FPG IS NULL) THEN
 NEW.COD_FPG = GEN_ID(GEN_FORMASPAG, 1);
END;



----------------- PARTICIPANTES--------------
 
CREATE TABLE PARTICIPANTES(
    COD_PART INTEGER NOT NULL,
    NOME_PART VARCHAR(200),
    EMAIL_PART VARCHAR(200),
    TELEFONE_PART VARCHAR(15),
    AREA_INTERESSE VARCHAR(200),
    CPF VARCHAR(15)    
);


ALTER TABLE PARTICIPANTES 
ADD CONSTRAINT PK_PARTICIPANTES
PRIMARY KEY (COD_PART);

CREATE SEQUENCE GEN_PART;

CREATE TRIGGER PARTICIPANTES_BI FOR PARTICIPANTES
ACTIVE BEFORE INSERT POSITION 0
AS
BEGIN
 IF(NEW.COD_PART IS NULL) THEN
  NEW.COD_PART = GEN_ID(GEN_PART, 1);
END;

--------------- Palestrantes-------------------

CREATE TABLE Palestrantes (
    COD_Pal INTEGER NOT NULL,
    Nome_Pal VARCHAR(200),
    COD_AREA INTEGER NOT NULL);

ALTER TABLE PALESTRANTES
ADD CONSTRAINT PK_PALESTRANTES
PRIMARY KEY(COD_PAL);

CREATE SEQUENCE GEN_PAL;

CREATE TRIGGER PALESTRANTES_BI FOR PALESTRANTES
ACTIVE BEFORE INSERT POSITION 0
AS
BEGIN
 IF(NEW.COD_PAL IS NULL) THEN
    NEW.COD_PAL = GEN_ID(GEN_PAL, 1);
END;

ALTER TABLE PALESTRANTES 
ADD CONSTRAINT FK_PALESTRANTES_AREA
 FOREIGN KEY(COD_AREA)
 REFERENCES AREA_CONHECIMENTO(COD_AREA)
 ON UPDATE CASCADE;




-------------------Eventos------------------------
   CREATE TABLE Eventos (
    COD_EVENTO INTEGER NOT NULL,
    TITULO_EV VARCHAR (200),
    DESCRICAO_EV VARCHAR(250),
    DATA_EV DATE,
    LOCAL_EV VARCHAR(200),
    COD_AREA INTEGER NOT NULL,
    COD_PALESTRANTE_EV INTEGER NOT NULL,
    VAGAS_EV INTEGER,
    VALOR_INSCRICAO_EV DECIMAL(15,2));

ALTER TABLE EVENTOS 
ADD CONSTRAINT PK_EVENTOS
PRIMARY KEY(COD_EVENTO);

CREATE SEQUENCE GEN_EVENTOS;

CREATE TRIGGER EVENTOS_BI FOR EVENTOS
ACTIVE BEFORE INSERT POSITION 0
AS 
BEGIN
 IF(NEW.COD_EVENTO IS NULL) THEN
    NEW.COD_EVENTO = GEN_ID(GEN_EVENTOS, 1);
END; 

ALTER TABLE EVENTOS 
ADD CONSTRAINT FK_EVENTOS_AREA
FOREIGN KEY(COD_AREA)
REFERENCES AREA_CONHECIMENTO(COD_AREA)
ON UPDATE CASCADE;

ALTER TABLE EVENTOS
ADD CONSTRAINT FK_EVENTOS_PALESTRANTE
FOREIGN KEY(COD_PALESTRANTE_EV)
REFERENCES PALESTRANTES(COD_PAL)
ON UPDATE CASCADE;
--------------------------Condição Pagamento--------------------------------------
CREATE TABLE COND_PAG(
    COD_COND INTEGER NOT NULL,
    NOME_COND VARCHAR(200),
    N_PARCELAS INTEGER,
    INTERVALO_PARCELAS SMALLINT
);

ALTER TABLE COND_PAG
ADD CONSTRAINT PK_COND_PAG
PRIMARY KEY(COD_COND);

CREATE SEQUENCE GEN_COND_PAG;

CREATE TRIGGER COND_PAG_BI FOR COND_PAG
ACTIVE BEFORE INSERT POSITION 0
AS 
BEGIN
 IF(NEW.COD_COND IS NULL) THEN
 NEW.COD_COND = GEN_ID(GEN_COND_PAG, 1);
END;




------------------------Contas-------------------------
 CREATE TABLE FINANCEIRO(
    COD_CONTA INTEGER NOT NULL,
    COD_EVENTO INTEGER NOT NULL,
    DESCRICAO_CONTA VARCHAR(100),
    TIPO_CONTA VARCHAR(1),
    DATA_CONTA DATE,
    COD_COND INTEGER NOT NULL,
    NNOTA_CONTA VARCHAR(30),
    VALOR_CONTA DECIMAL(15,2),
    QTDPARCELAS_CONTA integer,
    COD_FAVORECIDO INTEGER,
    TIPOFAVORECIDO VARCHAR(3),
    Situacao_Conta VARCHAR(1)
    
);


ALTER TABLE FINANCEIRO
ADD CONSTRAINT PK_COD_CONTA
PRIMARY KEY(COD_CONTA);

CREATE SEQUENCE GEN_CONTA;

CREATE TRIGGER CONTA_BI FOR FINANCEIRO
ACTIVE BEFORE INSERT POSITION 0
AS
BEGIN
 IF(NEW.COD_CONTA IS NULL) THEN
    NEW.COD_CONTA = GEN_ID(GEN_CONTA, 1);
END;

ALTER TABLE FINANCEIRO
ADD CONSTRAINT FK_FINAN_COD_EVENTO
 FOREIGN KEY(COD_EVENTO)
 REFERENCES EVENTOS(COD_EVENTO)
 ON UPDATE CASCADE;

ALTER TABLE FINANCEIRO
ADD CONSTRAINT FK_FINAN_COD_COND
 FOREIGN KEY(COD_COND)
 REFERENCES COND_PAG(COD_COND)
 ON UPDATE CASCADE;

COMMENT ON COLUMN FINANCEIRO.TIPO_CONTA IS
'P = Pagar
R = Receber';
 

COMMENT ON COLUMN FINANCEIRO.TIPOFAVORECIDO IS
'PAR = Participante
PAL = Palestrante
EVE = Evento';

COMMENT ON COLUMN FINANCEIRO.situacao_conta IS
'P = Pendente
Q = Quitada
C = Cancelada';

------------------------PARCELAS---------------------------
CREATE TABLE PARCELAS(
    COD_PARCELA INTEGER NOT NULL,
    COD_CONTA_PARCELA INTEGER NOT NULL,
    NUM_PARCELA INTEGER,
    DATA_VENC_PARCELA DATE,
    VALOR_PARCELA DECIMAL(15,2),
    SITUACAO_PARCELA INTEGER,
    VALOR_PAGO_PARCELA DECIMAL(15,2)

);

ALTER TABLE PARCELAS
ADD CONSTRAINT PK_COD_PARCELA
PRIMARY KEY(COD_PARCELA);

CREATE SEQUENCE GEN_PARCELA;

CREATE TRIGGER PARCELA_BI FOR PARCELAS
ACTIVE BEFORE INSERT POSITION 0
AS
BEGIN
 IF(NEW.COD_PARCELA IS NULL) THEN
 NEW.COD_PARCELA = GEN_ID(GEN_PARCELA, 1);
 END;

ALTER TABLE PARCELAS
ADD CONSTRAINT FK_PARCELAS_COD_CONTA
 FOREIGN KEY(COD_CONTA_PARCELA)
 REFERENCES FINANCEIRO(COD_CONTA)
 ON UPDATE CASCADE;

COMMENT ON COLUMN Parcelas.Situacao_Parcela IS 
'0=Pendentes
1=Quitadas
2= Canceladas';




---------------------Inscricao------------------------
CREATE TABLE INSCRICOES(
    COD_INSCRICAO INTEGER NOT NULL,
    COD_EVENTO INTEGER NOT NULL,
    COD_PARTICIPANTE INTEGER NOT NULL,
    TIPO_PAGAMENTO INTEGER,
    COD_CONTA INTEGER NOT NULL

);
ALTER TABLE INSCRICOES
ADD CONSTRAINT PK_COD_INSCRICAO
PRIMARY KEY (COD_INSCRICAO);

CREATE SEQUENCE GEN_INSCRICAO;

CREATE TRIGGER INSCRICOES_BI FOR INSCRICOES
ACTIVE BEFORE INSERT POSITION 0
AS
BEGIN
 IF(NEW.COD_INSCRICAO IS NULL) THEN
 NEW.COD_INSCRICAO = GEN_ID(GEN_INSCRICAO, 1);
 END;

ALTER TABLE INSCRICOES 
ADD CONSTRAINT FK_INSCRICOES_COD_EVENTO
 FOREIGN KEY(COD_EVENTO)
 REFERENCES EVENTOS(COD_EVENTO)
 ON UPDATE CASCADE;

ALTER TABLE INSCRICOES
ADD CONSTRAINT FK_INSCRICOES_COD_PARTICIPANTE
 FOREIGN KEY(COD_PARTICIPANTE)
 REFERENCES PARTICIPANTES(COD_PART)
 ON UPDATE CASCADE;

ALTER TABLE INSCRICOES 
ADD CONSTRAINT FK_INSCRICOES_COD_CONTA
 FOREIGN KEY(COD_CONTA)
 REFERENCES FINANCEIRO(COD_CONTA)
 ON UPDATE CASCADE;

 --tipo pag = 0 presencial = 1 online
------------------------ Pagamentos---------------------------
CREATE TABLE PAGAMENTOS (
    COD_PAGAMENTO INTEGER NOT NULL,
    COD_PARCELA INTEGER NOT NULL,
    COD_FPG INTEGER NOT NULL,
    VALOR_PAGAMENTO DECIMAL(15,2),
    DATA_HORA TIMESTAMP,
    EXTORNADO VARCHAR(1)

);

ALTER TABLE PAGAMENTOS
ADD CONSTRAINT PK_COD_PAGAMENTO
 PRIMARY KEY(COD_PAGAMENTO);

CREATE SEQUENCE GEN_PAGAMENTOS;

CREATE TRIGGER PAGAMENTOS_BI FOR PAGAMENTOS
ACTIVE BEFORE INSERT POSITION 0
AS
BEGIN
 IF(NEW.COD_PAGAMENTO IS NULL) THEN
 NEW.COD_PAGAMENTO = GEN_ID(GEN_PAGAMENTOS, 1);
 END;

ALTER TABLE PAGAMENTOS
ADD CONSTRAINT FK_PAGAMENTOS_COD_PARCELA
 FOREIGN KEY(COD_PARCELA)
 REFERENCES PARCELAS(COD_PARCELA)
 ON UPDATE CASCADE;

ALTER TABLE PAGAMENTOS 
ADD CONSTRAINT FK_PAGAMENTOS_COD_FPG
 FOREIGN KEY(COD_FPG)
 REFERENCES FORMASPAG(COD_FPG)
 ON UPDATE CASCADE;
 
CREATE TRIGGER PAGAMENTOS_AI FOR PAGAMENTOS
ACTIVE AFTER INSERT POSITION 0
as
begin
  Update parcelas PC set
  Pc.VALOR_PAGO_PARCELA = pc.VALOR_PAGO_PARCELA + NEW.valor_PAGAMENTO
  Where COD_PARCELA = New.Cod_Parcela;
end;


CREATE TRIGGER trg_atualiza_situacao_parcela FOR parcelas
BEFORE INSERT OR UPDATE POSITION 0
AS
BEGIN
    IF (NEW.valor_pago_parcela = NEW.valor_parcela) THEN
    BEGIN
        NEW.situacao_parcela = 1;
    END
END;



-----------------------Favorecidos---------------------------------

CREATE TABLE Favorecidos(
    COD_fav INTEGER NOT NULL,
    NOME_fav VARCHAR(200));

ALTER TABLE Favorecidos
ADD CONSTRAINT PK_Favorecido
PRIMARY KEY (COD_fav);

CREATE SEQUENCE GEN_Favorecido;

CREATE TRIGGER Favorecido_BI FOR Favorecidos
ACTIVE BEFORE INSERT POSITION 0
AS
BEGIN
 IF(NEW.COD_fav IS NULL) THEN
    NEW.COD_fav = GEN_ID(GEN_favorecido, 1);
END;
    


----------------Presenças--------------------------
CREATE TABLE PRESENCAS(
    COD_PRESENCA INTEGER NOT NULL,
    COD_EVENTO INTEGER NOT NULL,
    COD_PARTICIPANTE INTEGER NOT NULL,
    COD_INSCRICAO INTEGER NOT NULL,
    DATA_PRESENCA TIMESTAMP
);

ALTER TABLE PRESENCAS
ADD CONSTRAINT PK_PRESENCA
PRIMARY KEY(COD_PRESENCA);

CREATE SEQUENCE GEN_Presenca;

CREATE TRIGGER PRESENCA_BI FOR PRESENCAS
ACTIVE BEFORE INSERT POSITION 0
AS 
BEGIN
 IF(NEW.COD_PRESENCA IS NULL) THEN
    NEW.COD_PRESENCA = GEN_ID(GEN_PRESENCA, 1);
END;

ALTER TABLE PRESENCAS
ADD CONSTRAINT FK_PRESENCAS_COD_EVENTO
 FOREIGN KEY(COD_EVENTO)
 REFERENCES EVENTOS(COD_EVENTO)
 ON UPDATE CASCADE;

ALTER TABLE PRESENCAS 
ADD CONSTRAINT FK_PRESENCAS_COD_PARTICIPANTE
 FOREIGN KEY(COD_PARTICIPANTE)
 REFERENCES PARTICIPANTES(COD_PART)
 ON UPDATE CASCADE;

ALTER TABLE PRESENCAS
ADD CONSTRAINT FK_PRESENCAS_COD_INSCRICAO
 FOREIGN KEY(COD_INSCRICAO)
 REFERENCES INSCRICOES(COD_INSCRICAO)
 ON UPDATE CASCADE;



CREATE TRIGGER trg_atualizar_situacao_conta FOR PARCELAS
ACTIVE AFTER UPDATE POSITION 0
AS
BEGIN
    IF (NEW.SITUACAO_PARCELA = 1) THEN
    BEGIN
        UPDATE financeiro
        SET situacao_conta = 'Q'
        WHERE COD_CONTA = NEW.COD_CONTA_PARCELA;
    END
END



